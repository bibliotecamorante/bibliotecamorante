<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modulo di Donazione</title>
    <style>
        input[type="number"] {
            -moz-appearance: textfield;
        }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .book-entry {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <form id="donationForm">
        <label for="nome">Nome*</label>
        <input type="text" id="nome" required>
        <br>

        <label for="cognome">Cognome*</label>
        <input type="text" id="cognome" required>
        <br>

        <label for="email">Email*</label>
        <input type="email" id="email" required>
        <br>

        <label for="tessera">Numero Tessera</label>
        <input type="text" id="tessera">
        <br>

        <label for="telefono">Telefono</label>
        <input type="number" id="telefono" name="telefono" min="0">
        <br>

        <label>
            <input type="checkbox" id="accept" required>
            Accetto i termini e le condizioni*
        </label>
        <br>

        <div id="bookList">
            <!-- Container for book entries -->
        </div>

        <button type="button" onclick="createBookEntry()">Aggiungi Libro</button>
        <br>

        <button type="submit">Invia Donazione</button>
    </form>

    <script>
        let bookCount = 0;

        function createBookEntry() {
            const bookList = document.getElementById('bookList');
            const bookDiv = document.createElement('div');
            bookDiv.className = 'book-entry';
            bookDiv.innerHTML = `
                <label>Titolo*</label>
                <input type="text" class="book-title" required>
                <br>

                <label>Autore</label>
                <input type="text" class="book-author">
                <br>

                <label>Editore</label>
                <input type="text" class="book-publisher">
                <br>

                <label>Anno</label>
                <input type="number" class="book-year" min="1000" max="9999">
                <br>

                <label>ISBN</label>
                <input type="number" class="book-isbn">
                <br>

                <button type="button" onclick="removeBookEntry(this)">Rimuovi Libro</button>
            `;

            bookList.appendChild(bookDiv);
            bookCount++;
        }

        function removeBookEntry(button) {
            const bookDiv = button.parentElement;
            bookDiv.remove();
            bookCount--;
        }

        async function generateExcel(formData, books) {
            console.log('Generazione file Excel...', { formData, books });
            // Simulazione di generazione file Excel
            return new Promise(resolve => setTimeout(resolve, 1000));
        }

        document.getElementById('donationForm').addEventListener('submit', async function(event) {
            event.preventDefault();

            const nome = document.getElementById('nome').value.trim();
            const cognome = document.getElementById('cognome').value.trim();
            const email = document.getElementById('email').value.trim();
            const tessera = document.getElementById('tessera').value.trim();
            const telefono = document.getElementById('telefono').value.trim();
            const acceptCheckbox = document.getElementById('accept');

            if (!nome || !cognome || !email) {
                alert('Per favore compila tutti i campi obbligatori.');
                return;
            }

            if (!acceptCheckbox.checked) {
                alert('Devi accettare i termini e le condizioni per procedere.');
                return;
            }

            if (telefono && isNaN(telefono)) {
                alert('Il numero di telefono deve essere un valore numerico.');
                return;
            }

            const books = [];
            const bookEntries = document.querySelectorAll('.book-entry');

            for (const bookDiv of bookEntries) {
                const title = bookDiv.querySelector('.book-title').value.trim();
                const year = bookDiv.querySelector('.book-year').value.trim();
                const isbn = bookDiv.querySelector('.book-isbn').value.trim();

                if (!title) {
                    alert('Per favore inserisci almeno il titolo per ogni libro.');
                    return;
                }

                if (year && (isNaN(year) || year < 1000 || year > 9999)) {
                    alert('L\'anno deve essere un numero compreso tra 1000 e 9999.');
                    return;
                }

                if (isbn && isNaN(isbn)) {
                    alert('L\'ISBN deve essere un valore numerico.');
                    return;
                }

                const book = {
                    title: title,
                    author: bookDiv.querySelector('.book-author').value.trim(),
                    publisher: bookDiv.querySelector('.book-publisher').value.trim(),
                    year: year,
                    isbn: isbn
                };
                books.push(book);
            }

            if (books.length === 0) {
                alert('Aggiungi almeno un libro alla donazione.');
                return;
            }

            const formData = {
                nome,
                cognome,
                email,
                tessera,
                telefono
            };

            try {
                const submitButton = event.target.querySelector('button[type="submit"]');
                const originalText = submitButton.textContent;
                submitButton.disabled = true;
                submitButton.textContent = 'Generazione documento in corso...';

                await generateExcel(formData, books);

                submitButton.disabled = false;
                submitButton.textContent = originalText;
                event.target.reset();
                const bookList = document.getElementById('bookList');
                bookList.innerHTML = '';
                bookCount = 0;
                createBookEntry();
            } catch (error) {
                console.error('Errore durante la generazione del file Excel:', error);
                alert('Si è verificato un errore durante la generazione del documento. Riprova più tardi.');

                const submitButton = event.target.querySelector('button[type="submit"]');
                submitButton.disabled = false;
                submitButton.textContent = originalText;
            }
        });

        // Crea il primo campo libro automaticamente all'avvio
        createBookEntry();
    </script>
</body>
</html>
