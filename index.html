<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Donazione alla Biblioteca Elsa Morante</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
            text-align: center;
        }

        .header-container svg {
            height: 80px;
            width: auto;
            object-fit: contain;
        }

        .header-container h1 {
            margin: 0;
            color: #2c3e50;
            font-size: 2.2em;
            line-height: 1.2;
        }

        /* Media query per dispositivi mobili */
        @media screen and (max-width: 600px) {
            .header-container {
                flex-direction: column;
                gap: 15px;
            }

            .header-container svg {
                height: 60px; /* Leggermente più piccolo su mobile */
            }

            .header-container h1 {
                font-size: 1.8em; /* Testo più piccolo su mobile */
                text-align: center;
                width: 100%;
            }
        }


        h3 {
            color: #34495e;
            margin: 25px 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #2c3e50;
            font-weight: 500;
        }

        input[type="text"],
        input[type="tel"],
        input[type="email"] {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        input[type="text"]:focus,
        input[type="tel"]:focus,
        input[type="email"]:focus {
            border-color: #3498db;
            outline: none;
        }

        .book-entry {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
            transition: transform 0.2s ease;
        }

        .book-entry:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .book-counter {
            position: absolute;
            top: -10px;
            right: -10px;
            background: #3498db;
            color: white;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
        }

        .button-group {
            text-align: center;
            margin: 20px 0;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .add-book {
            background-color: #2ecc71;
            color: white;
            margin: 10px 0;
            width: 100%;
        }

        .add-book:hover {
            background-color: #27ae60;
            transform: translateY(-2px);
        }

        .remove-book {
            background-color: #e74c3c;
            color: white;
            padding: 8px 16px;
            font-size: 14px;
            position: absolute;
            top: 10px;
            right: 10px;
        }

        .remove-book:hover {
            background-color: #c0392b;
        }

        button[type="submit"] {
            background-color: #3498db;
            color: white;
            width: 100%;
            max-width: 300px;
            margin: 20px auto;
            display: block;
        }

        button[type="submit"]:hover {
            background-color: #2980b9;
        }

        .consent-box {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }

        .consent-box label {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        .info-box {
            background-color: #e1f5fe;
            border-left: 4px solid #03a9f4;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 0 5px 5px 0;
        }

        a {
            color: #3498db;
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        .input-warning {
            color: #e74c3c;
            font-size: 0.8em;
            margin-top: 5px;
            animation: fadeInOut 3s;
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0; }
            10%, 90% { opacity: 1; }
        }

        @media (max-width: 600px) {
            .container {
                padding: 15px;
            }

            button {
                width: 100%;
                margin-bottom: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-container">
            <svg xmlns="http://www.w3.org/2000/svg" xml:space="preserve" viewBox="0 0 606 666"><path fill="#FFF" d="M377 667H1V1h606v666H377M100 308l-3 1v1l-29 12h-2l-5 2h-3l-2 1h-4l-2 1h-7l-2 1h-8v53c0 2 2 5 3 5l29 4 15 4 13 7c14 8 25 18 36 30 7 9 13 20 18 31l1 2 1 3 3 8 4 31v54c0 6 0 6 7 6h326c3 0 4-1 4-4v-21l-1-50-3-19-1-3-1-6-5-16-1-3-2-5-2-5-1-2c-12-24-27-44-47-61l-15-12 1-5v-1l3-2h1l3-3h1l4-3 2-2 4-3a184 184 0 0 0 60-129v-63H156v2l-1 72c-1 10-5 21-9 31-2 7-6 13-10 21l-3 2-1 2-2 2-1 2-2 2-2 3-2 2-7 7-4 3-2 2-3 3h-1l-3 2v1l-3 1v1z"/><path fill="#FB2E36" d="m481 444 1 2v6l5 11 1 6 1 3 3 18 1 50v21c0 3-1 4-4 4H163c-7 0-7 0-7-6v-54l-4-31c0-4-2-6-3-9l-1-3-1-2a126 126 0 0 0-54-60l-14-7-14-5-29-3c-1 0-3-3-3-5v-52l1-1h8l2 1v-2h7l2 1v-2h4l2 1v-2h3c3 2 5 2 5-2h2l2 2 25-12 1-2 1-1 2-1 1-1 2-1 1-1 3-2 4-3 2-2 4-3 7-7 2-2 2-3 2-2 1-2 2-2 1-2 2-3c4-7 8-13 10-20 4-10 8-21 9-31l1-73 1-1h335l1 1v61a184 184 0 0 1-61 130l-4 3-2 2-4 3-4 3-3 2-1 1-5 2 5 4 15 11c20 17 35 37 47 61l1 3 2 4 2 6m-98-139h1l3-3h1l3-4 4-2 3-4 3-1 1-3 5-4 1-3 2-1 1-3 2-1 1-3c13-20 21-43 21-68H214c-1 47-17 87-48 122h59a5055 5055 0 0 1 98 1l1-2 6 1h2l1-2 3 1h2l1-2 1 1h2l1-2 1 1h2l1-2 1 1 2 1 23-11 1-3 1 1c2 0 5 0 4-4l1 1 3-3m-45 82-16-2H166l10 11c9 12 17 25 22 40l2 3v2l7 24 2 2 6 40h213l6 1h1v-2l-3-24v-8l-5-12-2-4-1-3-7-11c-7-12-15-22-26-30-9-9-20-15-31-21h-3l-2-2-8-3-9-1z"/><path fill="#FB2E36" d="m97 310-1 2a1262 1262 0 0 1-27 10l28-12zM487 463l-5-11-1-5 6 16zM414 359l-5-4 5-2v6zM65 388zM149 465l4 8-4-8zM67 322c0 4-2 4-5 2l5-2zM481 444l-3-5 3 5zM422 347l4-3-4 3zM418 350l4-3-4 3zM428 342l4-3-4 3zM111 300l-4 3 4-3zM117 295l-4 3 4-3zM107 303l-3 2 3-2zM415 352l3-2-3 2zM103 306l-2 1 2-1zM100 308l-2 1 2-1zM489 472l-1-3 1 3zM126 286l-2 2 2-2zM133 277l-2 2 2-2zM136 272l-2 3 2-3zM130 281l-2 2 2-2zM59 324v2l-2-1 2-1zM53 325v2l-2-1 2-1zM44 326v2l-2-1 2-1zM147 460l1 2-1-2zM477 434l-2-2 2 2zM493 148l-1-1 1 1zM157 147l-1 1 1-1zM34 327l-1 1 1-1z"/><path fill="#FFF" d="m412 276-1 2-2 2-1 2-2 2a298 298 0 0 0-12 12l-3 3-4 3-4 3-3 2-1 1-4 2-1 1a2449 2449 0 0 1-28 11l-2 1h-2l-2 1h-2l-2 1h-4l-2 1h-7l-2 1H166c31-35 47-75 48-122h221a125 125 0 0 1-23 71zM360 394c11 5 22 11 31 20a125 125 0 0 1 34 44l2 5 4 12 1 7 3 25H215l-6-41-8-26-1-2-1-3c-6-14-14-27-23-39l-10-11h156l17 2a463 463 0 0 0 18 6l3 1z"/><path fill="#FB2E36" d="m348 322 26-11-1 2a1032 1032 0 0 1-25 9zM200 441zM355 391l-16-4 8 1 8 3zM432 474zM375 310l4-2c1 3-2 3-4 2zM387 302l4-3-4 3zM383 305l4-3-4 3zM394 296l4-3-4 3zM380 307l3-2-3 2zM340 324l2-1v2l-2-1zM321 327l2-1v2l-2-1zM412 276l2-2-2 2zM409 280l2-2-2 2zM406 284l2-2-2 2zM400 291l2-2-2 2zM344 323l2-1v2l-2-1zM336 325l2-1v2l-2-1zM330 326l2-1v2l-2-1zM434 507h1v1l-1-1zM425 458l-1-2 1 2zM198 436l2 2-2-2zM360 393h-3 3z"/></svg>
            <h1>Donazione alla Biblioteca Elsa Morante</h1>
        </div>
        
        <div class="info-box">
            Compila il modulo per donare i tuoi libri alla biblioteca. I campi contrassegnati con * sono obbligatori
        </div>

        <form id="donationForm">
            <h3>Dati Personali</h3>
            <div class="form-group">
                <label for="nome">Nome: *</label>
                <input type="text" id="nome" name="nome" required>
            </div>
            
            <div class="form-group">
                <label for="cognome">Cognome: *</label>
                <input type="text" id="cognome" name="cognome" required>
            </div>
            
            <div class="form-group">
                <label for="tessera">Numero Tessera:</label>
                <input type="text" id="tessera" name="tessera">
            </div>

            <div class="form-group">
                <label for="telefono">Telefono:</label>
                <input type="tel" id="telefono" name="telefono" pattern="[0-9]*">
            </div>
            
            <div class="form-group">
                <label for="email">Email: *</label>
                <input type="email" id="email" name="email" required>
            </div>

            <h3>Libri da donare</h3>
            <div id="bookList"></div>
            
            <div class="consent-box">
                <label>
                    <input type="checkbox" id="accept" name="accept" required>
                    Ho letto e accetto <a href="termini.pdf" target="_blank">termini e condizioni</a>
                </label>
            </div>
            
            <button type="submit">Accetta e Genera il Documento</button>
        </form>
    </div>

    <script>
        let bookCount = 0;

        function createBookEntry() {
            const bookDiv = document.createElement('div');
            bookDiv.className = 'book-entry';
            bookCount++;
            bookDiv.innerHTML = `
                <div class="book-counter">${bookCount}</div>
                <div class="form-group">
                    <label>Titolo: *</label>
                    <input type="text" class="book-title" required>
                </div>
                <div class="form-group">
                    <label>Autore:</label>
                    <input type="text" class="book-author">
                </div>
                <div class="form-group">
                    <label>Editore:</label>
                    <input type="text" class="book-publisher">
                </div>
                <div class="form-group">
                    <label>Anno:</label>
                    <input type="tel" class="book-year" pattern="[0-9]*">
                </div>
                <div class="form-group">
                    <label>ISBN:</label>
                    <input type="tel" class="book-isbn" pattern="[0-9]*" maxlength="13">
                </div>
                <button type="button" class="remove-book" onclick="removeBook(this)">Rimuovi</button>
                <button type="button" class="add-book" onclick="createBookEntry()">+ Aggiungi Libro</button>
            `;
            document.getElementById('bookList').appendChild(bookDiv);
            updateBookCounters();
        }

        function removeBook(button) {
            button.parentElement.remove();
            bookCount--;
            updateBookCounters();
        }

        function updateBookCounters() {
            const bookEntries = document.querySelectorAll('.book-entry');
            bookEntries.forEach((entry, index) => {
                entry.querySelector('.book-counter').textContent = index + 1;
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            const telefonoInput = document.getElementById('telefono');
            telefonoInput.addEventListener('input', function(e) {
                const originalValue = e.target.value;
                e.target.value = originalValue.replace(/[^0-9]/g, '');
                
                if (originalValue !== e.target.value) {
                    showWarning(this, 'Inserire solo numeri nel campo Telefono');
                }
            });

            const emailInput = document.getElementById('email');
            emailInput.addEventListener('input', function(e) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                const originalValue = e.target.value;

                if (originalValue && !emailRegex.test(originalValue)) {
                    showWarning(this, 'Inserire un indirizzo email valido');
                }
            });

            document.getElementById('bookList').addEventListener('input', function(e) {
                if (e.target.classList.contains('book-year') || e.target.classList.contains('book-isbn')) {
                    const originalValue = e.target.value;
                    const currentYear = new Date().getFullYear();
                    
                    if (e.target.classList.contains('book-year')) {
                        let numericValue = originalValue.replace(/[^0-9]/g, '');
                        
                        if (numericValue.length > 0) {
                            const year = parseInt(numericValue);
                            if (numericValue.length === 4) {
                                if (year < 1800 || year > currentYear) {
                                    numericValue = numericValue.slice(0, -1);
                                    showWarning(e.target, `L'anno deve essere compreso tra 1800 e ${currentYear}`);
                                }
                            } else if (numericValue.length > 4) {
                                numericValue = numericValue.slice(0, 4);
                            } else {
                                if (numericValue.length === 1 && (numericValue < '1')) {
                                    numericValue = '';
                                    showWarning(e.target, `L'anno deve essere compreso tra 1800 e ${currentYear}`);
                                } else if (numericValue.length === 2 && (numericValue < '18')) {
                                    numericValue = numericValue.slice(0, -1);
                                    showWarning(e.target, `L'anno deve essere compreso tra 1800 e ${currentYear}`);
                                } else if (numericValue.length === 3 && parseInt(numericValue) < 180) {
                                    numericValue = numericValue.slice(0, -1);
                                    showWarning(e.target, `L'anno deve essere compreso tra 1800 e ${currentYear}`);
                                }
                            }
                        }
                        e.target.value = numericValue;
                    }
                    
                    if (e.target.classList.contains('book-isbn')) {
                        const numericValue = originalValue.replace(/[^0-9]/g, '');
                        
                        if (numericValue.length > 13) {
                            e.target.value = numericValue.slice(0, 13);
                            showWarning(e.target, 'L\'ISBN può contenere massimo 13 cifre');
                        } else {
                            if (originalValue !== numericValue) {
                                e.target.value = numericValue;
                                showWarning(e.target, 'Inserire solo numeri nel campo ISBN');
                            }
                        }
                    }
                }
            });

            function showWarning(element, message) {
                const existingWarning = element.nextElementSibling;
                if (existingWarning && existingWarning.classList.contains('input-warning')) {
                    existingWarning.remove();
                }

                const warning = document.createElement('div');
                warning.textContent = message;
                warning.className = 'input-warning';
                
                element.parentNode.insertBefore(warning, element.nextSibling);

                setTimeout(() => {
                    if (warning.parentNode) {
                        warning.remove();
                    }
                }, 3000);
            }
        });

        async function generateExcel(formData, books) {
            const workbook = new ExcelJS.Workbook();
            const worksheet = workbook.addWorksheet('Donazione');

            const titleStyle = {
                font: { size: 16, bold: true, color: { argb: '002060' } },
                alignment: { horizontal: 'center' }
            };
            
            const headerStyle = {
                font: { bold: true, color: { argb: 'FFFFFF' }, size: 14 },
                fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: '2F5496' } },
                alignment: { horizontal: 'center', vertical: 'middle' },
                border: {
                    top: { style: 'thin' },
                    left: { style: 'thin' },
                    bottom: { style: 'thin' },
                    right: { style: 'thin' }
                }
            };

            const dataStyle = {
                font: { size: 14 },
                alignment: { vertical: 'middle' },
                border: {
                    top: { style: 'thin' },
                    left: { style: 'thin' },
                    bottom: { style: 'thin' },
                    right: { style: 'thin' }
                }
            };

            // Intestazione documento
            worksheet.mergeCells('A2:G2');
            const titleCell = worksheet.getCell('A2');
            titleCell.value = 'DONAZIONE ALLA BIBLIOTECA ELSA MORANTE';
            titleCell.style = titleStyle;

            // Dati donatore
            worksheet.mergeCells('A4:B4');
            worksheet.mergeCells('C4:G4');
            worksheet.getCell('A4').value = 'DATI DONATORE';
            worksheet.getCell('A4').style = { ...headerStyle, alignment: { horizontal: 'left', vertical: 'middle' } };
            worksheet.getCell('C4').style = headerStyle;

            // Nome e Cognome, Tessera, Telefono, Email con formattazione separata
            worksheet.mergeCells('A5:B5');
            worksheet.mergeCells('C5:G5');
            worksheet.getCell('A5').value = 'Nome e Cognome:';
            worksheet.getCell('C5').value = `${formData.nome} ${formData.cognome}`;
            
            
            
            worksheet.mergeCells('A6:B6');
            worksheet.mergeCells('C6:G6');
            worksheet.getCell('A6').value = 'Tessera:';
            worksheet.getCell('C6').value = formData.tessera || '---';
            
            worksheet.mergeCells('A7:B7');
            worksheet.mergeCells('C7:G7');
            worksheet.getCell('A7').value = 'Telefono:';
            worksheet.getCell('C7').value = formData.telefono || '---';
            
            worksheet.mergeCells('A8:B8');
            worksheet.mergeCells('C8:G8');
            worksheet.getCell('A8').value = 'Email:';
            worksheet.getCell('C8').value = formData.email;

            // Applica stili ai dati del donatore
            for (let row = 5; row <= 8; row++) {
                worksheet.getCell(`A${row}`).style = { ...dataStyle, font: { bold: true } }; // Etichetta in grassetto
                worksheet.getCell(`C${row}`).style = dataStyle; // Dati formattati
            }

            // Aggiungi la stringa "DICHIARAZIONE"
            worksheet.mergeCells('A10:G10');
            const declarationCell = worksheet.getCell('A10');
            declarationCell.value = 'DICHIARAZIONE';
            declarationCell.style = { ...headerStyle, font: { size: 14, bold: true }, fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'f39c12' } } };

            // Testo dichiarazione
            worksheet.mergeCells('A11:G14');
            worksheet.getCell('A11').value = 'Con la presente dono alla Biblioteca le risorse documentarie elencate di seguito e autorizzo la biblioteca a destinarli all\'uso che riterrà più opportuno (acquisizione al patrimonio, scambio, dono, bookcrossing o scarto, nel caso in cui, a giudizio insindacabile della biblioteca, i materiali risultino inutilizzabili) senza alcun vincolo per la biblioteca stessa nei miei confronti.';
            worksheet.getCell('A11').style = { ...dataStyle, alignment: { wrapText: true, vertical: 'middle' } };

             // Intestazione tabella libri
    const headers = ['N.', 'Titolo', 'Autore', 'Editore', 'Anno', 'ISBN'];
    worksheet.getRow(16).values = headers;
    worksheet.getRow(16).eachCell(cell => {
        cell.style = headerStyle;
    });

    // Dati libri
    books.forEach((book, index) => {
        const row = worksheet.getRow(index + 17);
        row.values = [index + 1, book.title, book.author, book.publisher, book.year, book.isbn];
        row.eachCell(cell => {
            cell.style = dataStyle;
        });
        row.height = 25;
    });

    // Imposta larghezza colonne aggiornate
    worksheet.columns = [
        { width: 4 },    // N.
        { width: 50 },   // Titolo (ampiamente allargata)
        { width: 30 },   // Autore
        { width: 30 },   // Editore
        { width: 12 },   // Anno
        { width: 20 },   // ISBN (ampiamente allargata)
    ];

    // Genera il file
    const buffer = await workbook.xlsx.writeBuffer();
    const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `donazione_${formData.cognome}_${formData.nome}_${new Date().toLocaleDateString('it-IT').replace(/\//g, '-')}.xlsx`;
    a.click();
    window.URL.revokeObjectURL(url);
}

        

        // Event Listener per il form
        document.getElementById('donationForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            
            const nome = document.getElementById('nome').value.trim();
            const cognome = document.getElementById('cognome').value.trim();
            const email = document.getElementById('email').value.trim();
            const tessera = document.getElementById('tessera').value.trim();
            const telefono = document.getElementById('telefono').value.trim();
            const acceptCheckbox = document.getElementById('accept');
            
            if (!nome || !cognome || !email) {
             alert('Per favore compila tutti i campi obbligatori.');
                return;
            }
            
            if (!acceptCheckbox.checked) {
                alert('Devi accettare i termini e le condizioni per procedere.');
                return;
            }

            const books = [];
            const bookEntries = document.querySelectorAll('.book-entry');
            
            for (const bookDiv of bookEntries) {
                const title = bookDiv.querySelector('.book-title').value.trim();
                
                if (!title) {
                    alert('Per favore inserisci almeno il titolo per ogni libro.');
                    return;
                }
                
                const book = {
                    title: title,
                    author: bookDiv.querySelector('.book-author').value.trim(),
                    publisher: bookDiv.querySelector('.book-publisher').value.trim(),
                    year: bookDiv.querySelector('.book-year').value.trim(),
                    isbn: bookDiv.querySelector('.book-isbn').value.trim()
                };
                books.push(book);
            }

            if (books.length === 0) {
                alert('Aggiungi almeno un libro alla donazione.');
                return;
            }
            
            const formData = {
                nome,
                cognome,
                email,
                tessera,
                telefono
            };
            
            try {
                // Mostra indicatore di caricamento
                const submitButton = event.target.querySelector('button[type="submit"]');
                const originalText = submitButton.textContent;
                submitButton.disabled = true;
                submitButton.textContent = 'Generazione documento in corso...';
                
                await generateExcel(formData, books);
                
                // Ripristina il bottone
                submitButton.disabled = false;
                submitButton.textContent = originalText;
                
               // Reset form
event.target.reset();
const bookList = document.getElementById('bookList');
bookList.innerHTML = '';
bookCount = 0;
createBookEntry();

            } catch (error) {
                console.error('Errore durante la generazione del file Excel:', error);
                alert('Si è verificato un errore durante la generazione del documento. Riprova più tardi.');
                
                // Ripristina il bottone in caso di errore
                const submitButton = event.target.querySelector('button[type="submit"]');
                submitButton.disabled = false;
                submitButton.textContent = originalText;
            }
        });

        // Crea il primo libro quando la pagina si carica
        document.addEventListener('DOMContentLoaded', createBookEntry);
    </script>
</body>
</html>
